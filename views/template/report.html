{% extends 'base.html' %}

{% block title %}Báo cáo chi tiết{% endblock %}

{% block content %}
<br>
<div class="report-container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">Detailed report</h2>
    <div class="center">
      <div class="dropdown">
        <button class="btn btn-primary button-resize dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Export
        </button>
        <ul class="dropdown-menu" aria-labelledby="exportDropdown">
          <li><a class="dropdown-item" href="#">Export as PDF</a></li>
          <li><a class="dropdown-item" href="#">Export as Word</a></li>
        </ul>
      </div>
    </div>
  </div>

  <ul class="nav nav-tabs mb-3">
    <li class="nav-item flex-fill">
      <a class="nav-link active text-center" href="#overview" data-bs-toggle="tab">Overview</a>
    </li>
    <li class="nav-item flex-fill">
      <a class="nav-link text-center" href="#iot" data-bs-toggle="tab">IoT Devices</a>
    </li>
    <li class="nav-item flex-fill">
      <a class="nav-link text-center" href="#history" data-bs-toggle="tab">Booking History</a>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
          <div class="p-3 rounded text-center">
            <div class="fw-bold">Total room number</div>
            <div class="fs-4">{{ total_rooms }}</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 rounded text-center">
            <div class="fw-bold">In Use</div>
            <div class="fs-4 text-success">{{ in_use }}</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 rounded text-center">
            <div class="fw-bold">Devices In Use</div>
            <div class="fs-4">{{ active_devices }}/{{ total_devices }}</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 rounded text-center">
            <div class="fw-bold">Booking Rate</div>
            <div class="fs-4 text-warning">{{ booking_rate }}%</div>
          </div>
        </div>
      </div>

      <div class="p-3 rounded shadow-sm mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Usage chart</h5>
          <div class="btn-group" role="group" aria-label="Chart time range">
            <button type="button" class="btn btn-sm btn-outline-primary active" data-time-range="week">Week</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-time-range="month">Month</button>
          </div>
        </div>
        <!-- Hidden input to store the selected time range -->
        <input type="hidden" id="chartTimeRange" value="week">
        <!-- Placeholder for usage chart -->
        <div id="usageChart" style="height: 200px; background: #e7f1ff; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
          <span id="chartPlaceholderText">Showing Weekly Data</span>
        </div>
      </div>

      <div class="p-3 rounded shadow-sm">
        <h5>Detailed Statistics</h5>
        <div class="row">
          <div class="col-6">Total number of orders:</div>
          <div class="col-6 text-end fw-bold">{{ total_bookings }} lần</div>
          <div class="col-6">Average time/time:</div>
          <div class="col-6 text-end fw-bold">{{ avg_time }}</div>
          <div class="col-6">Most booked rooms:</div>
          <div class="col-6 text-end fw-bold">{{ most_booked_room }}</div>
          <div class="col-6">Peak hours:</div>
          <div class="col-6 text-end fw-bold">{{ peak_hours }}</div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="iot">
      <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
          <div class="p-3 rounded text-center">
            <div class="fw-bold">Total devices</div>
            <div class="fs-4">{{ total_devices }}</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="p-3 rounded text-center">
            <div class="fw-bold">Need maintenance</div>
            <div class="fs-4 text-danger">{{ maintenance_needed }}</div>
          </div>
        </div>
      </div>
      
      <div class="d-flex flex-column gap-3">
        {% for device in devices %}
        <div class="bg-white p-3 rounded shadow-sm">
          <div class="d-flex justify-content-between">
            <div class="fw-bold">{{ device.room.roomID }}</div>
            <div class="text-muted small">Bảo trì: {{ device.maintenance_date }}</div>
          </div>
          <div class="mt-2">
            <div class="row">
              {% for equip in device.equipment %}
                <div class="col-6 col-md-3 d-flex align-items-center mb-2">
                  <span class="badge rounded-circle {{ 'bg-success' if equip.status == 'ok' else 'bg-danger' if equip.status == 'reserved' else 'bg-warning' }}"
                    style="width: 10px; height: 16px; margin-right: 8px;">
                  </span>
                  <span>{{ equip.name }}</span>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="tab-pane fade" id="history">
      <div class="mb-3">
        <h5>Recent booking history</h5>
        {% for booking in bookings %}
        <div class="border-bottom py-2">
          {{ booking.room.roomID }} -
          {{ booking.timeSlot.startTime.strftime('%d/%m/%Y %H:%M') }} -
          {{ booking.timeSlot.endTime.strftime('%H:%M') }} -
          <span class="fw-bold">
            {{ 'Hoàn thành' if booking.status == 'confirmed' else 'Đã hủy' }}
          </span>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
  /* Mobile adjustments */
  @media (max-width: 767px) {
    .report-container {
      width: 100%;
      padding: 10px;
    }
    .dropdown-menu {
      width: 100%;
      text-align: center;
    }
  }

  /* Desktop adjustments */
  @media (min-width: 768px) {
    body {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); /* Gradient background for desktop */
    }
    .report-container {
      max-width: 1000px; /* Limit width to 1000px */
      margin: 0 auto; /* Center the container */
      background-color: #f8f9fa; /* Match the body background from base.html */
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .center .btn {
      width: auto; /* Override w-100 on desktop */
    }
    .dropdown-menu {
      min-width: 150px; /* Ensure dropdown menu is wide enough on desktop */
    }
  }

  /* Centering class */
  .center {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Button resize class */
  .button-resize {
    max-width: 200px;
  }

  /* Style the dropdown menu */
  .dropdown-menu {
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .dropdown-item {
    padding: 10px 20px;
    font-size: 0.9rem;
  }

  .dropdown-item:hover {
    background-color: #e3f2fd;
    color: #007bff;
  }

  /* Style for the chart placeholder */
  #usageChart {
    position: relative;
  }

  #chartPlaceholderText {
    font-size: 1rem;
    color: #555;
  }

  /* Dark Mode Styles */
  body.dark-mode .report-container {
    background-color: #2c3e50; /* Darker background for content area */
  }
  body.dark-mode .bg-light {
    background-color: #34495e; /* Darker background for cards */
  }
  body.dark-mode .bg-light .fw-bold,
  body.dark-mode .bg-light .fs-4 {
    color: #e0e0e0; /* Light text for readability */
  }
  body.dark-mode .bg-light .text-success {
    color: #90ee90; /* Lighter green for readability while maintaining success indication */
  }
  body.dark-mode .bg-light .text-warning {
    color: #ffd700; /* Lighter yellow for readability while maintaining warning indication */
  }
  body.dark-mode .bg-light .text-danger {
    color: #ff4040; /* Lighter red for readability while maintaining danger indication */
  }
  body.dark-mode .bg-white {
    background-color: #34495e; /* Darker background for sections */
  }
  body.dark-mode .bg-white .col-6,
  body.dark-mode .bg-white .text-muted,
  body.dark-mode .bg-white .fw-bold,
  body.dark-mode .tab-pane h5,
  body.dark-mode .tab-pane .border-bottom {
    color: #e0e0e0; /* Light text for readability */
  }
  body.dark-mode .border-bottom {
    border-color: #4a6a8a !important; /* Darker border for visibility */
  }
  body.dark-mode .nav-tabs {
    border-bottom: 1px solid #4a6a8a; /* Darker border for tabs */
  }
  body.dark-mode .nav-tabs .nav-link {
    color: #e0e0e0; /* Light text for tabs */
    background-color: #2c3e50; /* Dark background for inactive tabs */
  }
  body.dark-mode .nav-tabs .nav-link.active {
    color: #e0e0e0; /* Light text for active tab */
    background-color: #34495e; /* Slightly lighter background for active tab */
    border-color: #4a6a8a #4a6a8a #34495e; /* Adjust border colors */
  }
  body.dark-mode .dropdown-menu {
    background-color: #34495e; /* Darker dropdown background */
    border-color: #4a6a8a; /* Darker border */
  }
  body.dark-mode .dropdown-item {
    color: #e0e0e0; /* Light text for dropdown items */
  }
  body.dark-mode .dropdown-item:hover {
    background-color: #4a6a8a; /* Darker hover background */
    color: #e0e0e0; /* Keep light text on hover */
  }
  body.dark-mode #usageChart {
    background-color: #2c3e50; /* Darker chart background */
  }
  body.dark-mode #chartPlaceholderText {
    color: #b0b0b0; /* Lighter gray for placeholder text */
  }
  body.dark-mode .btn-primary:hover {
    background-color: #4f80ff; /* Lighter blue for hover */
  }
  body.dark-mode .btn-outline-primary {
    color: #e0e0e0; /* Light text */
    border-color: #4f80ff; /* Match primary color */
  }
  body.dark-mode .btn-outline-primary:hover {
    background-color: #4f80ff; /* Lighter blue for hover */
    color: #fff; /* White text on hover */
  }
  body.dark-mode .btn-outline-secondary {
    color: #e0e0e0; /* Light text */
    border-color: #4a6a8a; /* Darker border */
  }
  body.dark-mode .btn-outline-secondary:hover {
    background-color: #4a6a8a; /* Darker hover background */
    color: #fff; /* White text on hover */
  }
</style>

<script>
  // Get the buttons and chart elements
  const weekBtn = document.querySelector('button[data-time-range="week"]');
  const monthBtn = document.querySelector('button[data-time-range="month"]');
  const chartTimeRangeInput = document.getElementById('chartTimeRange');
  const chartPlaceholderText = document.getElementById('chartPlaceholderText');

  // Function to update the chart based on the selected time range
  function updateChart(timeRange) {
    // Update the hidden input
    chartTimeRangeInput.value = timeRange;

    // Simulate chart update (for now, just change the placeholder text)
    if (timeRange === 'week') {
      chartPlaceholderText.textContent = 'Showing Weekly Data';
    } else {
      chartPlaceholderText.textContent = 'Showing Monthly Data';
    }

    // TODO: Integrate with a charting library (e.g., Chart.js)
    // 1. Fetch data for the selected time range (e.g., via AJAX to Flask backend)
    // 2. Update the chart with the new data
    // Example:
    // fetch(`/api/usage-data?range=${timeRange}`)
    //   .then(response => response.json())
    //   .then(data => {
    //     // Update chart with data
    //     myChart.data.datasets[0].data = data.values;
    //     myChart.update();
    //   });
  }

  // Add event listeners to the buttons
  weekBtn.addEventListener('click', () => {
    // Toggle active class
    weekBtn.classList.add('active');
    monthBtn.classList.remove('active');
    // Update chart
    updateChart('week');
  });

  monthBtn.addEventListener('click', () => {
    // Toggle active class
    monthBtn.classList.add('active');
    weekBtn.classList.remove('active');
    // Update chart
    updateChart('month');
  });

  // Initialize the chart with the default time range (week)
  updateChart('week');
</script>
{% endblock %}