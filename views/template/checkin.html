{% extends 'base.html' %}

{% block title %}Check-in{% endblock %}

{% block content %}
{% set hide_bottom_nav = True %}
{% set disable_body_scroll = True %}
<style>
    .button-eff{
        transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
    }
    .button-eff:hover{
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
</style>
<div class="header text-center py-3">
    <h4 class="fw-bold">Check-in</h4>
</div>
<div class="main-content d-flex flex-column align-items-center justify-content-center p-3">
    {% if message %}
        <div class="alert alert-success" role="alert">
            {{ message }}
        </div>
        <div class="room-info bg-white border rounded p-3" style="width: 100%; max-width: 300px;">
            <p><strong>Room {{ space.roomID }}</strong></p>
            <p class="icon-text d-flex align-items-center gap-2">
                <i class="bi bi-clock"></i>
                {{ space.timeSlot.startTime.strftime('%H:%M') if space.timeSlot else 'N/A' }} - {{ space.timeSlot.endTime.strftime('%H:%M') if space.timeSlot else 'N/A' }}
            </p>
            <p class="icon-text d-flex align-items-center gap-2">
                <i class="bi bi-gear"></i>
                {% for equip in space.equipment %}
                    {{ equip }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </p>
        </div>
    {% else %}
        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% endif %}
        <div class="qr-placeholder bg-white border rounded d-flex flex-column align-items-center justify-content-center mb-3" style="width: 100%; max-width: 300px; height: 200px; position: relative;">
            <div style="font-size: 2rem; color: #aaa;">⟟⟟</div>
            <div style="position: absolute; bottom: 10px; font-size: 0.9rem; color: #555;">Tap to scan QR code</div>
        </div>
        <button class="scan-button btn mb-3 button-eff" onclick="startQRScanner()" style="background-color: #007bff; color: #fff; width: 100%; max-width: 300px;">Scan QR Code</button>
        <div class="room-info bg-white border rounded p-3" style="width: 100%; max-width: 300px;">
            <p><strong>Phòng {{ space.roomID }}</strong></p>
            <p class="icon-text d-flex align-items-center gap-2">
                <i class="bi bi-clock"></i>
                {{ space.timeSlot.startTime.strftime('%H:%M') if space.timeSlot else 'N/A' }} - {{ space.timeSlot.endTime.strftime('%H:%M') if space.timeSlot else 'N/A' }}
            </p>
            <p class="icon-text d-flex align-items-center gap-2">
                <i class="bi bi-gear"></i>
                {% for equip in space.equipment %}
                    {{ equip }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </p>
        </div>
        <div style="display: none;">
            <video id="video"></video>
            <canvas id="canvas"></canvas>
            <form method="POST" id="qrForm">
                <input type="text" id="qr_code" name="qr_code">
            </form>
        </div>
    {% endif %}
</div>

<script>
    async function startQRScanner() {
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');

        // Request camera access
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.play();

        canvasElement.style.display = 'block';
        video.style.display = 'none';

        function tick() {
            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                document.getElementById('qr_code').value = code.data;
                document.getElementById('qrForm').submit(); // Auto-submit the form
            } else {
                requestAnimationFrame(tick);
            }
        }
        requestAnimationFrame(tick);
    }
</script>
{% endblock %}